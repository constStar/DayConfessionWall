<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.conststar.wall.mapper.MapperTable">

    <resultMap id="PojoTableMap" type="PojoTable" autoMapping="true">
        <id column="id" property="id"/>

        <association property="support" column="{tableId=id,userId=select_user_id}" javaType="_boolean"
                     select="isSupport"/>
        <association property="userPublic" column="id" javaType="PojoUserPublic" select="getUser"/>
    </resultMap>

    <sql id="selectTable">
        select a.id,
               a.user_id,
               a.sender,
               a.sender_sex,
               a.recipient,
               a.recipient_sex,
               a.create_time,
               a.anonymous,
               a.content,
               a.images,
               a.status,
               #{userId}          as select_user_id,
               COALESCE(b.ans, 0) as comment_count,
               COALESCE(c.ans, 0) as support_count
        from `table` as a
                 left join (select table_id as id, count(1) as ans from `comment` GROUP BY table_id) as b
                           on b.id = a.id
                 left join (select table_id as id, count(1) as ans from `support` GROUP BY table_id) as c
                           on c.id = a.id
                 left join `user` as u on a.user_id = u.id
    </sql>

    <!--获取分页帖子-->
    <select id="getTablesLimit" resultMap="PojoTableMap">
        <include refid="selectTable"></include>
        where (a.status = 0 or a.user_id = #{userId})
        and u.status = 0
        order by a.create_time DESC limit #{startIndex}, #{pageSize};
    </select>

    <!--获取单个帖子内容-->
    <select id="getTable" parameterType="_int" resultMap="PojoTableMap">
        <include refid="selectTable"></include>
        where a.id = #{id}
        and (a.status = 0 or a.user_id = #{userId})
        and u.status = 0
        group by a.id;
    </select>

    <!--搜索帖子-->
    <select id="getSearchTablesLimit" resultMap="PojoTableMap">
        <include refid="selectTable"></include>
        where (a.sender like "%"#{keyword}"%"
        or a.recipient like "%"#{keyword}"%"
        or a.content like "%"#{keyword}"%")
        and (a.status = 0 or a.user_id = #{userId})
        and u.status = 0
        group by a.id
        order by a.create_time DESC limit #{startIndex}, #{pageSize};
    </select>

    <!--点赞-->
    <insert id="addSupport">
        insert into `support` (table_id, user_id)
        values (#{tableId}, #{userId});
    </insert>

    <!--取消点赞-->
    <delete id="removeSupport">
        delete
        from `support`
        where table_id = #{tableId}
          and user_id = #{userId};
    </delete>

    <!--获取帖子总数量-->
    <select id="getCount" resultType="_int">
        select count(1)
        from `table`
                 left join `user` on `user`.id = `table`.user_id
        where (`table`.status = 0 or `table`.user_id = #{userId})
          and `user`.status = 0;
    </select>

    <!--获取帖子搜索总数量-->
    <select id="getSearchCount" resultType="_int">
        select count(1)
        from `table`
                 left join `user` on `user`.id = `table`.user_id
        where (`table`.sender like "%"#{keyword}"%"
            or `table`.recipient like "%"#{keyword}"%"
            or `table`.content like "%" #{keyword}"%")
          and (`table`.status = 0 or `table`.user_id = #{userId})
          and `user`.status = 0;
    </select>

    <!--发布表白-->
    <insert id="addTable">
        insert into `table` (user_id, anonymous, sender, sender_sex, recipient,
                             recipient_sex, create_time, content, images, status)
            value (#{userId}, #{anonymous}, #{sender}, #{senderSex}, #{recipient},
                   #{recipientSex}, now(), #{content}, #{images}, #{status});
    </insert>

    <!--获取帖子的用户信息-->
    <select id="getUser" resultType="PojoUserPublic">
        select `user`.*
        from `user`,
             `table`
        where `table`.user_id = `user`.id
          and `table`.id = #{tableId}
          and anonymous = 0
          and (`table`.status = 0 or user_id = #{userId})
    </select>

    <!--用户是否点过赞-->
    <select id="isSupport" resultType="_boolean">
        select count(1)
        from `support`
        where table_id = #{tableId}
          and user_id = #{userId};
    </select>
</mapper>